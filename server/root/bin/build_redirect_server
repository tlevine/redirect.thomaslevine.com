#!/bin/sh
# Run this script on the server to install dependencies.
# It expects the business card Debian that Prometeus provides.

# Install nginx
echo '
# nginx
deb http://nginx.org/packages/debian/ squeeze nginx
deb-src http://nginx.org/packages/debian/ squeeze nginx
' >> /etc/apt/sources.list
apt-get update
gpg --keyserver keyserver.ubuntu.com --recv-key ABF5BD827BD9BF62
gpg -a --export ABF5BD827BD9BF62 | apt-key add -

# Nginx
apt-get update
update-rc.d nginx defaults

# Clear any default nginx configuration.
cgi=$(mktemp)
mv /etc/nginx/conf.d/0-cgi $cgi
rm -R /etc/nginx/conf.d
mkdir /etc/nginx/conf.d
mv $cgi /etc/nginx/conf.d

# Copy my nginx configuration
cp -R ~/etc/conf.d /etc/nginx

# Chown nginx sites directory to www-data
chown -r www-data: /etc/nginx/conf.d

# Chown slash page to www-data
chown -r www-data: /srv/splash



# uWSGI
apt-get install build-essential psmisc python-dev libxml2 libxml2-dev python-setuptools
pip install uwsgi

# uWSGI web stuff
adduser uwsgi
chown uwsgi: /home/uwsgi
chown -r uwsgi: /srv/v1
chmod +x /srv/v1/app.py

# Daemon hack
su uwsgi -c 'echo "@reboot /srv/v1/app.py"'

# Restart nginx to enable the new configuration.
service nginx restart
