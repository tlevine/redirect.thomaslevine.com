#!/bin/sh
# Run this script on the server to install dependencies.
# It expects Arch Linux from ChicagoVPS.

# apt-get update

# Install nginx
apt-get install nginx
update-rc.d nginx defaults

# Clear any default nginx configuration.
cgi=$(mktemp)
mv /etc/nginx/conf.d/0-redirect.thomaslevine.com $cgi
rm -R /etc/nginx/conf.d
mkdir /etc/nginx/conf.d
mv $cgi /etc/nginx/conf.d/0-redirect.thomaslevine.com

# Chown nginx sites directory to www-data
chown -R www-data: /etc/nginx/conf.d

# Chown slash page to www-data
chown -R www-data: /srv/splash



# uWSGI
apt-get install python-pip
pip install uwsgi bottle

# uWSGI web stuff
useradd uwsgi
chown uwsgi: /home/uwsgi
chown -R uwsgi: /srv/v1
chmod +x /srv/v1/app.py

# Daemon hack
apt-get install tmux
chmod +x /home/uwsgi/bin/start_pseudo_daemon
su uwsgi -c 'echo "@reboot /home/uwsgi/bin/start_pseudo_daemon"'
su uwsgi -c '/home/uwsgi/bin/start_pseudo_daemon'

# Restart nginx to enable the new configuration.
service nginx restart
